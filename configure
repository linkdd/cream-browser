#!/bin/sh

PACKAGE="Cream-Browser"
VERSION="unstable"

PREFIX="/usr/local"
SYSCONFDIR="$PREFIX/etc"
TOPDIR=`pwd`
DEBUG=0

MODULES="www ftp about"

WANT_GTK="2.0"

while true
do
     case $1 in
          --prefix=*)
               PREFIX="${1#--prefix=}"
               shift
               ;;

          --prefix)
               PREFIX=$2
               shift 2
               ;;

          --sysconfdir=*)
               SYSCONFDIR="${1#--sysconfdir=}"
               shift
               ;;

          --sysconfdir)
               SYSCONFDIR=$2
               shift 2
               ;;

          --enable-*)
               mod="${1#--enable-}"
               MODULES="$MODULES $mod"
               shift
               ;;

          --disable-*)
               mod="${1#--disable-}"
               MODULES="${MODULES/$mod/}"
               shift
               ;;

          --debug)
               DEBUG=1
               shift
               ;;

          --with-gtk=*)
               WANT_GTK="${1#--with-gtk=}"
               shift
               ;;

          --help)
               echo "Usage: ./configure [options]"
               echo
               echo "Options:"
               echo "    --help                   Print this help"
               echo
               echo "Installation directories:"
               echo "    --prefix=PREFIX"
               echo "    --prefix PREFIX          Install files in PREFIX [/usr/local]"
               echo "    --sysconfdir=DIR"
               echo "    --sysconfdir DIR         Read-only single-machine data [PREFIX/etc]"
               echo
               echo "Modules:"
               echo "    --enable-MODULE          Build MODULE"
               echo "    --disable-MODULE         Don't build MODULE"
               echo
               echo "Build options:"
               echo "    --debug                  Build in debug mode (with more strict build options and some debugging features in the code)"
               echo "    --with-gtk=(2.0,3.0)     Build with GTK+-2.0 or GTK+-3.0 [2.0]"

               exit
               ;;

          *)
               break
               ;;
     esac
done

ARCH=`uname -m`
echo -n "-- Building on $ARCH "
if [ "$DEBUG" = "1" ]; then
     echo "in debug mode"
     CFLAGS="-g -ggdb3 -fno-inline -Wall -Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith -Wno-sign-compare -O2 -I $TOPDIR/"
else
     echo "in release mode"
     CFLAGS="-Wall -O2 -I $TOPDIR/"
fi
LDFLAGS=""

# Check CC
if [ "x$CC" = "x" ]; then
     CC="gcc"
fi

echo -n "-- Checking for compiler ($CC) ... "
compiler=`which $CC`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check pkg-config
echo -n "-- Checking for pkg-config ... "
which pkg-config > /dev/null 2>&1
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check sed
echo -n "-- Checking for sed ... "
SED=`which sed`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check for glib
echo -n "-- Checking for library glib-2.0 ... "
GLIB_VERSION=`pkg-config --modversion glib-2.0`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     GLIB_CFLAGS=`pkg-config --cflags glib-2.0`
     GLIB_LDFLAGS=`pkg-config --libs glib-2.0`
     echo "$GLIB_VERSION"
fi

# Check for gtk
echo -n "-- Checking for library gtk+-$WANT_GTK ... "
GTK_VERSION=`pkg-config --modversion gtk+-$WANT_GTK`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     GTK_CFLAGS=`pkg-config --cflags gtk+-$WANT_GTK`
     GTK_LDFLAGS=`pkg-config --libs gtk+-$WANT_GTK`
     echo "$GTK_VERSION"
fi

# Check for lua
echo -n "-- Checking for library lua ... "
LUA_VERSION=`pkg-config --modversion lua`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     LUA_CFLAGS=`pkg-config --cflags lua`
     LUA_LDFLAGS=`pkg-config --libs lua`
     echo "$LUA_VERSION"
fi

CFLAGS="$CFLAGS $GLIB_CFLAGS $GTK_CFLAGS $LUA_CFLAGS"
LDFLAGS="$LDFLAGS $GLIB_LDFLAGS $GTK_LDFLAGS $LUA_LDFLAGS"

# -- common.mk
echo -n "Creating: common.mk"
$SED -e "s:@CC@:$compiler:
         s:@CFLAGS@:$CFLAGS:
         s:@LDFLAGS@:$LDFLAGS:
         s:@GLIB_VERSION@:$GLIB_VERSION:
         s:@GTK_VERSION@:$GTK_VERSION:
         s:@LUA_VERSION@:$LUA_VERSION:
         s:@MODULES@:$MODULES:
         s:@TOPDIR@:$TOPDIR:
         s:@PREFIX@:$PREFIX:
         s:@SYSCONFDIR@:$SYSCONFDIR:
         s:@HAVE_DEBUG@:$DEBUG:
         s:@ARCH@:$ARCH:
         s:@PACKAGE@:$PACKAGE:
         s:@VERSION@:$VERSION:" common.mk.in > common.mk

if [ "$?" = "1" ]; then
     echo " [ failed ]" && exit 1
else
     echo " [ ok ]"
fi

